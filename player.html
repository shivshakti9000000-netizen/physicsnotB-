<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing Video | PhysicsnotB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #38bdf8; --text: #f1f5f9; --border: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 20px; }

        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; position: sticky; top: 0; z-index: 100; }
        iframe { width: 100%; height: 100%; border: none; }

        .video-details { padding: 1.2rem; background: var(--surface); border-bottom: 1px solid var(--border); }
        .video-details h2 { font-size: 1.1rem; margin-bottom: 8px; }
        .video-details p { font-size: 0.85rem; color: #94a3b8; }

        .up-next { padding: 1.2rem; }
        .v-card { display: flex; gap: 12px; margin-bottom: 15px; cursor: pointer; }
        .v-thumb { width: 120px; aspect-ratio: 16/9; background: #334155; border-radius: 8px; flex-shrink: 0; }
        .v-info h4 { font-size: 0.85rem; margin-bottom: 4px; line-height: 1.2; }
        .v-info p { font-size: 0.75rem; color: #94a3b8; }

        .back-btn { position: absolute; top: 10px; left: 10px; z-index: 200; background: rgba(0,0,0,0.5); border: none; color: white; padding: 8px; border-radius: 50%; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="history.back()"><i data-lucide="arrow-left"></i></button>

    <div class="video-container" id="playerWrapper">
        <p style="text-align: center; margin-top: 20%;">Loading Video...</p>
    </div>

    <div class="video-details">
        <h2 id="vidTitle">Lecture Loading...</h2>
        <p id="vidTeacher">By Physics Expert</p>
    </div>

    <div class="up-next">
        <h4 style="margin-bottom: 15px;">Up Next</h4>
        <div id="nextVideos"></div>
    </div>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, increment, collection, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Firebase Configuration
    const videoConfig = {
        apiKey: "AIzaSyB3zKexi3a-4WniftHc_00Tc8rcRdda7pY",
        authDomain: "comj-b7bf6.firebaseapp.com",
        projectId: "comj-b7bf6",
        storageBucket: "comj-b7bf6.firebasestorage.app",
        appId: "1:137177672880:web:307a4cec9b901c6e8ddf75"
    };

    const vApp = initializeApp(videoConfig);
    const vDB = getFirestore(vApp);
    const realUser = localStorage.getItem('studentName');

    // URL se Video ID lena
    const urlParams = new URLSearchParams(window.location.search);
    const vidId = urlParams.get('id');

    // 2. TRACKING SYSTEM
    async function trackVideoProgress(id) {
        if (!realUser || !id) return;

        const studentRef = doc(vDB, "students", realUser);
        let history = JSON.parse(localStorage.getItem('watchHistory')) || [];

        // Check: Agar video pehle nahi dekha toh points badhao
        if (!history.includes(id)) {
            try {
                history.unshift(id);
                localStorage.setItem('watchHistory', JSON.stringify(history.slice(0, 10)));

                await setDoc(studentRef, {
                    name: realUser,
                    score: increment(10), 
                    videosWatched: increment(1),
                    lastWatched: new Date()
                }, { merge: true });

                console.log("Success: 10 Points Added, Boss!");
            } catch (e) {
                console.error("Tracking Error:", e);
            }
        }
    }

    // 3. LOAD VIDEO & PLAYER
    if (vidId) {
        // Firebase se video data lena
        onSnapshot(doc(vDB, "contents", vidId), (snap) => {
            if (snap.exists()) {
                const v = snap.data();
                
                // UI Update
                document.getElementById('vidTitle').innerText = v.title;
                document.getElementById('vidTeacher').innerText = "By " + (v.teacher || "Physics Expert");
                
                // Player Embed (YouTube ID use karke)
                const ytId = v.youtubeId; // Maan ke chal rahe hain aapne 'youtubeId' save kiya hai
                document.getElementById('playerWrapper').innerHTML = `
                    <iframe src="https://www.youtube.com/embed/${ytId}?autoplay=1&rel=0" 
                            allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                
                // Tracking Shuru karein
                trackVideoProgress(vidId);
            } else {
                document.getElementById('playerWrapper').innerHTML = "<p style='padding:20px;'>Video not found!</p>";
            }
        });
    } else {
        window.location.href = 'dashboard.html'; // ID nahi hai toh wapas bhej do
    }

    // Lucide icons refresh
    lucide.createIcons();
</script>


</body>
</html>